{% load static %}

<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <title>Itinerari UNESCO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'heritage/css/style.css' %}">
</head>

<body class="bg-light">
  <main class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="h3 m-0">Itinerari</h1>
      <a class="btn btn-outline-secondary" href="{% url 'home' %}">← Mappa</a>
    </div>

    {% if itinerari %}
      <div class="row g-3">
        {% for it in itinerari %}
          <div class="col-12 col-sm-6 col-lg-4">
            <div class="card card-itinerary h-100">
              <div class="card-body d-flex flex-column">

               <div class="d-flex align-items-center justify-content-between mb-2">
              <h2 class="h5 card-title m-0">{{ it.nome }}</h2>
              
              <div class="acc-badges">
                {% if it.has_wheelchair %}
                  <span class="badge-access" title="Accesso sedia a rotelle"><span class="sym">♿</span>Accesso</span>
                {% endif %}
                {% if it.has_visivi %}
                  <span class="badge-access" title="Ausili visivi"><span class="sym">👁️</span>Visivi</span>
                {% endif %}
                {% if it.has_uditivo %}
                  <span class="badge-access" title="Supporto uditivo"><span class="sym">🔊</span>Uditivo</span>
                {% endif %}
              </div>
            </div>

                {% if it.descrizione %}
                  <p class="card-text text-muted small">{{ it.descrizione|truncatewords:28 }}</p>
                {% endif %}

                <div class="mt-auto d-flex flex-wrap gap-2">
                  <a class="btn btn-soft-primary" href="{% url 'itinerario_dettaglio' it.pk %}">Dettagli</a>

                  {% if user.is_authenticated %}
                    {% if it.id in prenotati_ids %}
                      <button class="btn btn-soft-success btn-toggle-prenota"
                              data-url="{% url 'toggle_prenotazione' it.id %}">Prenotato ✓</button>
                    {% else %}
                      <button class="btn btn-primary btn-toggle-prenota"
                              data-url="{% url 'toggle_prenotazione' it.id %}">Segui</button>
                    {% endif %}
                  {% else %}
                    <a class="btn btn-primary" href="{% url 'login' %}?next={% url 'itinerari_list' %}">Accedi</a>
                  {% endif %}

                  <a class="btn btn-success" href="{% url 'booking_create' it.id %}">Prenota</a>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

      {% if is_paginated %}
        <nav class="mt-4">
          <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
              <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}">«</a>
              </li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">«</span></li>
            {% endif %}

            <li class="page-item active">
              <span class="page-link">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
            </li>

            {% if page_obj.has_next %}
              <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}">»</a>
              </li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">»</span></li>
            {% endif %}
          </ul>
        </nav>
      {% endif %}
    {% else %}
      <div class="alert alert-info">Non ci sono ancora itinerari.</div>
    {% endif %}
  </main>

  <script>
    document.addEventListener('click', async (e) => {
      const btn = e.target.closest('.btn-toggle-prenota');
      if (!btn) return;
      btn.disabled = true;

      try {
        const resp = await fetch(btn.dataset.url, {
          method: 'POST',
          headers: {'X-CSRFToken': getCookie('csrftoken')}
        });
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const data = await resp.json();

        if (data.status === 'added') {
          btn.classList.replace('btn-primary', 'btn-soft-success');
          btn.textContent = 'Prenotato ✓';
        } else {
          btn.classList.replace('btn-soft-success', 'btn-primary');
          btn.textContent = 'Segui';
        }
      } catch (err) {
        console.error(err);
      }

      btn.disabled = false;
    });

    function getCookie(name) {
      let v = null;
      document.cookie.split(';').forEach(c => {
        const s = c.trim();
        if (s.startsWith(name + '=')) v = decodeURIComponent(s.slice(name.length + 1));
      });
      return v;
    }
  </script>
</body>
</html>
